<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SCSA.ViewModels"
             xmlns:converters="using:SCSA.Converters"
             xmlns:local="using:SCSA.Views"
             xmlns:models="using:SCSA.Models"
             mc:Ignorable="d" d:DesignWidth="420" d:DesignHeight="800"
             x:Class="SCSA.Views.ParameterConfigurationToolView"
             x:DataType="vm:ParameterConfigurationToolViewModel">

  <Design.DataContext>
    <vm:ParameterConfigurationToolViewModel />
  </Design.DataContext>

  <UserControl.Resources>
    <!-- 枚举类型参数模板 -->
    <DataTemplate x:Key="EnumParameterTemplate">
      <ComboBox ItemsSource="{Binding EnumOptions}"
                SelectedItem="{Binding SelectedEnumOption, Mode=TwoWay}"
                FontSize="11"
                Height="24"
                Width="120"
                HorizontalAlignment="Stretch"
                BorderThickness="0">
        <ComboBox.ItemTemplate>
          <DataTemplate>
            <TextBlock Text="{Binding DisplayText}" FontSize="11"/>
          </DataTemplate>
        </ComboBox.ItemTemplate>
      </ComboBox>
    </DataTemplate>
    
    <!-- 布尔类型参数模板 -->
    <DataTemplate x:Key="BoolParameterTemplate">
      <ComboBox ItemsSource="{Binding SwitchOptions}"
                SelectedItem="{Binding SelectedSwitchOption, Mode=TwoWay}"
                FontSize="11"
                Height="24"
                Width="120"
                HorizontalAlignment="Stretch"
                BorderThickness="0">
        <ComboBox.ItemTemplate>
          <DataTemplate>
            <TextBlock Text="{Binding DisplayText}" FontSize="11"/>
          </DataTemplate>
        </ComboBox.ItemTemplate>
      </ComboBox>
    </DataTemplate>
    
    <!-- 整数类型参数模板 -->
    <DataTemplate x:Key="IntegerParameterTemplate">
      <NumericUpDown Value="{Binding Value, Mode=TwoWay}"
                     Minimum="{Binding MinValue}"
                     Maximum="{Binding MaxValue}"
                     Increment="1"
                     FormatString="F0"
                     FontSize="11"
                     Height="24"
                     Width="120"
                     HorizontalAlignment="Stretch"
                     ShowButtonSpinner="False"
                     BorderThickness="0"
                     Watermark="整数值"/>
    </DataTemplate>
    
    <!-- 浮点数类型参数模板 -->
    <DataTemplate x:Key="FloatParameterTemplate">
      <NumericUpDown Value="{Binding FloatValue, Mode=TwoWay}"
                     Minimum="{Binding MinValue}"
                     Maximum="{Binding MaxValue}"
                     Increment="0.1"
                     FormatString="F2"
                     FontSize="11"
                     Height="24"
                     Width="120"
                     HorizontalAlignment="Stretch"
                     ShowButtonSpinner="False"
                     BorderThickness="0"
                     Watermark="小数值"/>
    </DataTemplate>
    
    <!-- 默认数值类型参数模板 -->
    <DataTemplate x:Key="NumberParameterTemplate">
      <NumericUpDown Value="{Binding Value, Mode=TwoWay}"
                     Minimum="{Binding MinValue}"
                     Maximum="{Binding MaxValue}"
                     Increment="1"
                     FormatString="F0"
                     FontSize="11"
                     Height="24"
                     Width="120"
                     HorizontalAlignment="Stretch"
                     ShowButtonSpinner="False"
                     BorderThickness="0"
                     Watermark="数值"/>
    </DataTemplate>
    
    <!-- 参数模板选择器 -->
    <converters:ParameterTemplateSelector x:Key="ParameterTemplateSelector"
                                          EnumParameterTemplate="{StaticResource EnumParameterTemplate}"
                                          BoolParameterTemplate="{StaticResource BoolParameterTemplate}"
                                          IntegerParameterTemplate="{StaticResource IntegerParameterTemplate}"
                                          FloatParameterTemplate="{StaticResource FloatParameterTemplate}"
                                          NumberParameterTemplate="{StaticResource NumberParameterTemplate}"/>
  </UserControl.Resources>

  <DockPanel>
    <!-- 设备信息区域 -->
    <Border DockPanel.Dock="Top"
            BorderThickness="1" 
            CornerRadius="4" 
            Padding="8"
            Margin="8,8,8,4">
      <StackPanel Orientation="Horizontal" Spacing="4">
        <Ellipse Width="10" Height="10" 
                 Fill="Green" 
                 IsVisible="{Binding HasDevice}"/>
        <Ellipse Width="10" Height="10" 
                 Fill="Red" 
                 IsVisible="{Binding !HasDevice}"/>
        <TextBlock Text="{Binding HasDevice, Converter={x:Static converters:BoolConverters.ToConnectedDisconnected}}" 
                   VerticalAlignment="Center" 
                   FontSize="11"/>
      </StackPanel>
    </Border>

    <!-- 参数操作按钮 -->
    <Border DockPanel.Dock="Top"
            BorderThickness="1" 
            CornerRadius="4" 
            Padding="6"
            Margin="8,0,8,4">
      <StackPanel Spacing="6">
        <TextBlock Text="参数操作" FontWeight="Bold" FontSize="12"/>
        
        <!-- 按钮一排显示 -->
        <UniformGrid Rows="1" Columns="6" HorizontalAlignment="Center" MaxWidth="240">
          <!-- 读取按钮 -->
          <Button Command="{Binding ReadParametersCommand}"
                  Width="32" Height="32" 
                  Margin="2"
                  IsEnabled="{Binding IsConnected}"
                  ToolTip.Tip="读取参数"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center">
            <Path Width="32" Height="32" 
                  Fill="#4CAF50"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Stretch="Uniform"
                  Data="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19Z M16.5,17L12,14.5L7.5,17V7H16.5V17Z"/>
          </Button>
          
          <!-- 写入按钮 -->
          <Button Command="{Binding WriteParametersCommand}"
                  Width="32" Height="32" 
                  Margin="2"
                  IsEnabled="{Binding IsConnected}"
                  ToolTip.Tip="写入参数"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center">
            <Path Width="32" Height="32" 
                  Fill="#2196F3"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Stretch="Uniform"
                  Data="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
          </Button>
          
          <!-- 默认按钮 -->
          <Button Command="{Binding RestoreDefaultsCommand}"
                  Width="32" Height="32" 
                  Margin="2"
                  ToolTip.Tip="恢复默认值"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center">
            <Path Width="32" Height="32" 
                  Fill="#FF9800"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Stretch="Uniform"
                  Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M18,11H13L14.5,9.5C14.1,9.1 13.6,8.6 13.1,8.2C12.2,7.5 11.1,7.1 10,7.1C7.8,7.1 6,8.9 6,11.1S7.8,15.1 10,15.1C10.8,15.1 11.6,14.9 12.3,14.4L13.7,15.8C12.6,16.6 11.3,17.1 10,17.1C6.7,17.1 4,14.4 4,11.1S6.7,5.1 10,5.1C11.6,5.1 13.1,5.7 14.2,6.8L16,5H18V11Z"/>
          </Button>
          
          <!-- 保存按钮 -->
          <Button Command="{Binding SaveParametersCommand}"
                  Width="32" Height="32" 
                  Margin="2"
                  ToolTip.Tip="保存参数"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center">
            <Path Width="32" Height="32" 
                  Fill="#9C27B0"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Stretch="Uniform"
                  Data="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
          </Button>
          
          <!-- 另存为按钮 -->
          <Button Command="{Binding SaveAsParametersCommand}"
                  Width="32" Height="32" 
                  Margin="2"
                  ToolTip.Tip="另存为"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center">
            <Path Width="32" Height="32" 
                  Fill="#E91E63"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Stretch="Uniform"
                  Data="M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19H5V5H12V3H5M17.78,4C17.61,4 17.43,4.07 17.3,4.2L16.08,5.41L18.58,7.91L19.8,6.7C20.06,6.44 20.06,6 19.8,5.75L18.25,4.2C18.12,4.07 17.95,4 17.78,4M15.37,6.12L8,13.5V16H10.5L17.87,8.62L15.37,6.12Z"/>
          </Button>
          
          <!-- 加载按钮 -->
          <Button Command="{Binding LoadParametersCommand}"
                  Width="32" Height="32" 
                  Margin="2"
                  ToolTip.Tip="加载参数"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center">
            <Path Width="32" Height="32" 
                  Fill="#607D8B"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Stretch="Uniform"
                  Data="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6M18,20H6V4H13V9H18V20Z M8,12V14H16V12H8M8,16V18H13V16H8Z"/>
          </Button>
        </UniformGrid>
      </StackPanel>
    </Border>

    <!-- 底部区域 -->
    <StackPanel DockPanel.Dock="Bottom">
      <!-- 参数描述区域 -->
      <Border BorderThickness="1" 
              CornerRadius="4" 
              Padding="10" 
              Background="#F8F9FA"
              Margin="8,0,8,4">
        <StackPanel Spacing="5">
          <TextBlock Text="参数说明" FontWeight="Bold" FontSize="12" Foreground="#333"/>
          <TextBlock Text="{Binding SelectedParameter.Desc, FallbackValue='请选择一个参数查看详细说明'}" 
                     FontSize="11" 
                     TextWrapping="Wrap" 
                     Foreground="#666"
                     LineHeight="18"/>
        </StackPanel>
      </Border>
      
      <!-- 状态栏 -->
      <Border BorderThickness="1" 
              CornerRadius="4" 
              Padding="8"
              Margin="8,0,8,8">
        <StackPanel Orientation="Horizontal" Spacing="8">
          <Ellipse Width="7" Height="7">
            <Ellipse.Fill>
              <SolidColorBrush Color="{Binding IsOperating, Converter={x:Static converters:BoolConverters.ToOperatingColor}}"/>
            </Ellipse.Fill>
          </Ellipse>
          <TextBlock Text="{Binding StatusMessage}" 
                     FontSize="11" 
                     VerticalAlignment="Center"/>
        </StackPanel>
      </Border>
    </StackPanel>

    <!-- 参数列表（中央区域，自动填充剩余空间） -->
    <Border BorderThickness="1" 
            CornerRadius="4" 
            Padding="8"
            Margin="8,0,8,4">
      <StackPanel Spacing="6">
        <StackPanel Orientation="Horizontal" Spacing="8">
          <TextBlock Text="参数列表" FontWeight="Bold" FontSize="13"/>
          <TextBlock Text="{Binding FilteredParameters.Count, StringFormat='({0}项)'}" 
                     FontSize="11" 
                     VerticalAlignment="Center"/>
        </StackPanel>
        
        <!-- 分类选择 -->
        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,2">
          <TextBlock Text="分类:" FontSize="11" VerticalAlignment="Center" MinWidth="36"/>
          <ComboBox ItemsSource="{Binding AvailableCategories}"
                    SelectedItem="{Binding SelectedCategory}"
                    Width="140"
                    Height="26"
                    FontSize="11"/>
        </StackPanel>
        
      <!-- 参数列表 -->
      <DataGrid ItemsSource="{Binding FilteredParameters}"
                SelectedItem="{Binding SelectedParameter}"
                AutoGenerateColumns="False"
                GridLinesVisibility="Vertical"
                HeadersVisibility="Column"
                RowHeight="28"
                ColumnHeaderHeight="26"
                FontSize="11"
                MaxHeight="400">
          <DataGrid.Columns>
            <DataGridTextColumn Header="地址" 
                                Binding="{Binding Address, StringFormat='0x{0:X8}'}" 
                                Width="95" 
                                FontSize="11"
                                IsReadOnly="True"/>
            <DataGridTextColumn Header="名称" 
                                Binding="{Binding Name}" 
                                Width="125" 
                                FontSize="11"
                                IsReadOnly="True"/>
            <DataGridTemplateColumn Header="值" Width="135">
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ContentControl Content="{Binding}"
                                  ContentTemplate="{StaticResource ParameterTemplateSelector}"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>
            <DataGridTextColumn Header="单位" 
                                Binding="{Binding Unit}" 
                                Width="55" 
                                FontSize="11"
                                IsReadOnly="True"/>
          </DataGrid.Columns>
        </DataGrid>
      </StackPanel>
    </Border>
  </DockPanel>

</UserControl>